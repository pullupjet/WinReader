<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æ²‰æµ¸å¼é˜…è¯»å™¨ (Google Audio)</title>
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        body { 
            font-family: "Segoe UI", "Microsoft YaHei", sans-serif; 
            margin: 0; display: flex; height: 100vh; 
            background-color: #f0f2f5; overflow: hidden; 
        }
        
        /* --- ä¾§è¾¹æ  --- */
        #sidebar {
            flex: 0 0 320px; 
            background-color: #1e1e1e; 
            color: #d4d4d4; 
            position: relative; 
            display: flex; flex-direction: column; 
            border-right: 1px solid #333; 
            z-index: 10;
            box-shadow: 4px 0 15px rgba(0,0,0,0.3); 
        }

        /* --- é¡¶éƒ¨å·¥å…·æ  --- */
        .sidebar-header {
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
            background: #252526;
        }
        .app-title { font-size: 14px; font-weight: bold; letter-spacing: 1px; color: #fff; }
        
        .icon-btn {
            background: transparent; border: 1px solid #444; color: #ccc;
            width: 32px; height: 32px; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .icon-btn:hover { background: #3e3e42; color: white; border-color: #666; }

        /* --- ç¿»è¯‘æ˜¾ç¤ºåŒº --- */
        #translation-area { flex: 1; padding: 20px; overflow-y: auto; }

        /* --- è®¾ç½®æŠ½å±‰ --- */
        #settings-drawer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(30, 30, 30, 0.98); 
            backdrop-filter: blur(10px);
            padding: 20px; box-sizing: border-box;
            transform: translateX(-100%); 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 20; border-right: 1px solid #007acc;
            display: flex; flex-direction: column; overflow-y: auto;
        }
        #settings-drawer.active { transform: translateX(0); }

        .close-btn {
            align-self: flex-end; margin-bottom: 10px;
            background: none; border: none; color: #aaa; font-size: 24px; cursor: pointer;
        }
        .close-btn:hover { color: white; }

        /* --- æ§ä»¶æ ·å¼ --- */
        .btn-primary {
            background: linear-gradient(135deg, #007acc 0%, #005fa3 100%);
            color: white; border: none; padding: 12px; width: 100%; 
            font-size: 14px; font-weight: 600; border-radius: 8px; 
            cursor: pointer; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-outline {
            background: transparent; border: 1px solid #555; color: #ccc;
            padding: 8px; width: 100%; border-radius: 6px; cursor: pointer; margin-top: 5px;
        }
        .btn-outline:hover { background: #333; border-color: #888; }

        .settings-group { margin-bottom: 25px; }
        .settings-label { 
            font-size: 12px; color: #888; text-transform: uppercase; 
            margin-bottom: 12px; display: block; letter-spacing: 1px; border-bottom: 1px solid #444; padding-bottom: 5px;
        }
        .control-row {
            display: flex; flex-direction: column; gap: 8px;
            margin-bottom: 15px; font-size: 14px; color: #eee;
        }
        
        input[type=range] { width: 100%; accent-color: #007acc; cursor: pointer; }
        select {
            background: #3e3e42; color: white; border: 1px solid #555; 
            padding: 8px; border-radius: 4px; width: 100%; outline: none;
        }

        /* --- å¡ç‰‡ --- */
        .card { 
            background: #252526; border-radius: 8px; padding: 20px; 
            margin-bottom: 20px; border: 1px solid #333;
        }
        .card-title { 
            font-size: 11px; color: #858585; margin-bottom: 10px; 
            text-transform: uppercase; font-weight: bold;
        }
        #word-head { 
            font-size: 32px; color: #4ec9b0; font-weight: 700; margin-bottom: 8px; 
            line-height: 1.2; word-break: break-all;
        }
        .card-content { font-size: 15px; color: #cccccc; line-height: 1.6; }
        #sentence-en { 
            color: #9cdcfe; font-style: italic; margin-bottom: 12px; 
            padding-bottom: 12px; border-bottom: 1px solid #3e3e42; 
        }

        #book-area { flex: 1; background-color: #fcfcfc; position: relative; overflow: hidden; }
        #viewer { width: 100%; height: 100%; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header">
            <span class="app-title">READER PRO</span>
            <button id="menu-btn" class="icon-btn" title="è®¾ç½®">âš™ï¸</button>
        </div>

        <div id="translation-area">
            <div class="card">
                <div class="card-title">Word Definition</div>
                <div id="word-head">Start</div>
                <div id="word-meaning" class="card-content">
                    Google å‘éŸ³åŠŸèƒ½å·²å°±ç»ªã€‚
                </div>
            </div>

            <div class="card">
                <div class="card-title">Context</div>
                <div id="sentence-en" class="card-content"></div>
                <div id="sentence-cn" class="card-content">...</div>
            </div>
        </div>

        <div id="settings-drawer">
            <button id="close-menu-btn" class="close-btn">Ã—</button>
            
            <button id="open-btn" class="btn-primary">
                <span>ğŸ“‚</span> æ‰“å¼€ä¹¦ç±
            </button>

            <div class="settings-group">
                <span class="settings-label">Audio & Voice</span>
                
                <div class="control-row">
                    <span>é€‰æ‹©å‘éŸ³äºº (Voice)</span>
                    <select id="voice-select">
                        <option>åŠ è½½ä¸­...</option>
                    </select>
                </div>

                <div class="control-row">
                    <span>è¯­é€Ÿ (Speed): <span id="rate-val">1.0</span></span>
                    <input type="range" id="voice-rate" min="0.5" max="2.0" step="0.1" value="1.0">
                    <div style="font-size: 11px; color: #666; margin-top: 4px;">* è¯­é€Ÿè°ƒèŠ‚ä»…å¯¹æœ¬åœ°è¯­éŸ³æœ‰æ•ˆï¼ŒGoogle è¯­éŸ³ä¸ºæ ‡å‡†é€Ÿåº¦</div>
                </div>

                <button id="test-voice-btn" class="btn-outline">ğŸ”Š è¯•å¬å½“å‰è¯­éŸ³</button>
            </div>

            <div class="settings-group">
                <span class="settings-label">Typography</span>
                
                <div class="control-row">
                    <span>å­—å· (Size)</span>
                    <input type="range" id="font-size" min="14" max="36" step="1" value="18">
                </div>
                
                <div class="control-row">
                    <span>è¡Œé«˜ (Height)</span>
                    <input type="range" id="line-height" min="1.2" max="2.2" step="0.1" value="1.6">
                </div>

                <div class="control-row">
                    <span>å­—ä½“ (Font)</span>
                    <select id="font-family">
                        <option value="Microsoft YaHei">å¾®è½¯é›…é»‘</option>
                        <option value="Segoe UI">Segoe UI</option>
                        <option value="Arial">Arial</option>
                        <option value="Georgia">Georgia</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div id="book-area">
        <div id="viewer"></div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        const fs = require('fs');
        const localDict = require('./dictionary.js');
        const JSZip = require('jszip');
        window.JSZip = JSZip; 
        const ePubLib = require('epubjs');
        const ePub = ePubLib.default || ePubLib;
        const synth = window.speechSynthesis;

        let book = null;
        let rendition = null;
        let currentBookKey = ""; 
        let voices = [];
        let googleAudio = null; // ç”¨äºå­˜å‚¨å½“å‰çš„ Google éŸ³é¢‘å¯¹è±¡ï¼Œæ–¹ä¾¿åˆ‡æ­Œ

        let userSettings = {
            fontSize: 18,
            lineHeight: 1.6,
            fontFamily: "Microsoft YaHei",
            voiceName: "Google Online", // é»˜è®¤ä¼˜å…ˆå°è¯• Google
            voiceRate: 1.0
        };

        // --- 1. è¯­éŸ³åˆ—è¡¨åŠ è½½ (å¢åŠ äº† Google é€‰é¡¹) ---
        function loadVoices() {
            voices = synth.getVoices();
            const voiceSelect = document.getElementById('voice-select');
            voiceSelect.innerHTML = ""; 

            // === æ ¸å¿ƒï¼šæ‰‹åŠ¨æ·»åŠ  Google é€‰é¡¹åˆ°æœ€å‰é¢ ===
            const googleOption = document.createElement('option');
            googleOption.textContent = "ğŸŒ Google Online (è”ç½‘æ ‡å‡†éŸ³)";
            googleOption.value = "Google Online";
            googleOption.style.fontWeight = "bold"; // åŠ ç²—çªå‡ºæ˜¾ç¤º
            googleOption.style.color = "#4ec9b0"; 
            voiceSelect.appendChild(googleOption);

            // è¿‡æ»¤å¹¶æ·»åŠ æœ¬åœ°å£°éŸ³
            const enVoices = voices.filter(v => v.lang.includes('en') || v.lang.includes('US') || v.lang.includes('UK'));
            if (enVoices.length === 0) enVoices.push(...voices);

            enVoices.forEach(voice => {
                const option = document.createElement('option');
                option.textContent = `ğŸ’» [æœ¬åœ°] ${voice.name}`;
                option.value = voice.name;
                voiceSelect.appendChild(option);
            });

            // æ¢å¤é€‰æ‹©
            if (userSettings.voiceName) {
                // å¦‚æœæ˜¯ Googleï¼Œç›´æ¥é€‰ä¸­
                if (userSettings.voiceName === "Google Online") {
                    voiceSelect.value = "Google Online";
                } else {
                    // å¦‚æœæ˜¯æœ¬åœ°ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨
                    const exists = enVoices.some(v => v.name === userSettings.voiceName);
                    if (exists) voiceSelect.value = userSettings.voiceName;
                }
            }
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }
        // å»¶è¿Ÿä¸€ç‚¹åŠ è½½ï¼Œç¡®ä¿ Google é€‰é¡¹èƒ½æ¸²æŸ“å‡ºæ¥
        setTimeout(loadVoices, 500);


        // --- 2. ç•Œé¢ä¸è®¾ç½® ---
        const menuBtn = document.getElementById('menu-btn');
        const closeMenuBtn = document.getElementById('close-menu-btn');
        const drawer = document.getElementById('settings-drawer');

        function toggleMenu(show) {
            if (show) drawer.classList.add('active');
            else drawer.classList.remove('active');
        }
        menuBtn.onclick = () => toggleMenu(true);
        closeMenuBtn.onclick = () => toggleMenu(false);

        window.onload = () => {
            const savedSettings = localStorage.getItem('reader-settings');
            if (savedSettings) {
                userSettings = JSON.parse(savedSettings);
                document.getElementById('font-size').value = userSettings.fontSize;
                document.getElementById('line-height').value = userSettings.lineHeight;
                document.getElementById('font-family').value = userSettings.fontFamily;
                document.getElementById('voice-rate').value = userSettings.voiceRate;
                document.getElementById('rate-val').innerText = userSettings.voiceRate;
            }
            loadVoices(); // å†æ¬¡ç¡®ä¿åŠ è½½
            const lastBookPath = localStorage.getItem('lastOpenBookPath');
            if (lastBookPath && fs.existsSync(lastBookPath)) loadBook(lastBookPath);
        };

        const saveSettings = () => {
            localStorage.setItem('reader-settings', JSON.stringify(userSettings));
            if (rendition) applyThemeToRendition();
        };

        document.getElementById('voice-select').addEventListener('change', (e) => {
            userSettings.voiceName = e.target.value;
            saveSettings();
            speak("Voice changed"); // ç®€å•æµ‹è¯•
        });

        document.getElementById('voice-rate').addEventListener('input', (e) => {
            userSettings.voiceRate = e.target.value;
            document.getElementById('rate-val').innerText = e.target.value;
            saveSettings();
        });

        document.getElementById('test-voice-btn').addEventListener('click', () => {
            speak("This is a test of the Google audio quality.");
        });

        const updateStyle = () => {
            userSettings.fontSize = document.getElementById('font-size').value;
            userSettings.lineHeight = document.getElementById('line-height').value;
            userSettings.fontFamily = document.getElementById('font-family').value;
            saveSettings();
        };
        document.getElementById('font-size').addEventListener('input', updateStyle);
        document.getElementById('line-height').addEventListener('input', updateStyle);
        document.getElementById('font-family').addEventListener('change', updateStyle);

        // --- 3. ä¹¦ç±åŠ è½½ä¸äº¤äº’ ---
        document.getElementById('open-btn').addEventListener('click', () => ipcRenderer.send('open-file-dialog'));
        ipcRenderer.on('selected-file', (event, path) => {
            toggleMenu(false);
            localStorage.setItem('lastOpenBookPath', path);
            loadBook(path);
        });

        function loadBook(path) {
            currentBookKey = "epub-pos-" + path;
            const data = fs.readFileSync(path); 
            const arrayBuffer = data.buffer.slice(data.byteOffset, data.byteOffset + data.byteLength);

            if (book) book.destroy();
            book = ePub(arrayBuffer);
            
            document.getElementById('viewer').innerHTML = ''; 
            rendition = book.renderTo("viewer", {
                width: "100%",
                height: "100%",
                flow: "scrolled-doc",
                manager: "continuous"
            });

            rendition.hooks.render.register(() => applyThemeToRendition());

            const savedCfi = localStorage.getItem(currentBookKey);
            rendition.display(savedCfi || undefined);

            let saveTimeout;
            rendition.on('relocated', (location) => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    localStorage.setItem(currentBookKey, location.start.cfi);
                }, 500);
            });

            rendition.hooks.content.register(contents => {
                applyThemeToRendition(); 
                wrapWordsInBook(contents.document.body, contents);
            });
        }

        function applyThemeToRendition() {
            if (!rendition) return;
            rendition.themes.default({
                "p": { 
                    "font-size": `${userSettings.fontSize}px !important`,
                    "line-height": `${userSettings.lineHeight} !important`,
                    "font-family": `${userSettings.fontFamily} !important`,
                    "color": "#333 !important", "text-align": "justify" 
                },
                "div": {
                    "font-size": `${userSettings.fontSize}px !important`,
                    "line-height": `${userSettings.lineHeight} !important`,
                    "font-family": `${userSettings.fontFamily} !important`
                },
                "span.click-word": { "cursor": "pointer", "border-radius": "3px" },
                "span.click-word:hover": { "background-color": "rgba(33, 150, 243, 0.2)" },
                "span.click-word.active": { "background-color": "#007acc", "color": "white" }
            });
        }

        function wrapWordsInBook(element, contents) {
            const nodes = Array.from(element.childNodes);
            nodes.forEach(node => {
                if (node.nodeType === 3) { 
                    const text = node.nodeValue;
                    if (!text.trim()) return;
                    const tokens = text.split(/([a-zA-Z\u00C0-\u00FF]+)/g);
                    const fragment = document.createDocumentFragment();
                    tokens.forEach(token => {
                        if (/^[a-zA-Z\u00C0-\u00FF]+$/.test(token)) {
                            const span = document.createElement('span');
                            span.className = 'click-word';
                            span.innerText = token;
                            span.onclick = (e) => {
                                e.stopPropagation();
                                contents.document.querySelectorAll('.click-word.active').forEach(el => el.classList.remove('active'));
                                span.classList.add('active');
                                handleBookClick(token, span);
                            };
                            fragment.appendChild(span);
                        } else {
                            fragment.appendChild(document.createTextNode(token));
                        }
                    });
                    node.parentNode.replaceChild(fragment, node);
                } else if (node.nodeType === 1) { wrapWordsInBook(node, contents); }
            });
        }

        function handleBookClick(rawWord, spanElement) {
            const word = rawWord.toLowerCase();
            speak(rawWord);

            document.getElementById('word-head').innerText = rawWord;
            const localDef = localDict[word];
            if (localDef) {
                document.getElementById('word-meaning').innerText = "âš¡ [æœ¬åœ°] " + localDef;
            } else {
                document.getElementById('word-meaning').innerText = "æŸ¥è¯¢ä¸­...";
                translateText(word, 'word');
            }

            let parentBlock = spanElement.parentElement;
            while (parentBlock && window.getComputedStyle(parentBlock).display === 'inline') {
                parentBlock = parentBlock.parentElement;
            }
            if (parentBlock) {
                const fullText = parentBlock.innerText;
                const sentences = fullText.match(/[^.!?,;:\n\r]+[.!?,\n\r;:]+|$/g) || [fullText];
                const targetSentence = sentences.find(s => s.includes(rawWord)) || fullText;
                
                document.getElementById('sentence-en').innerText = targetSentence.trim();
                document.getElementById('sentence-cn').innerText = "Translating...";
                translateText(targetSentence, 'sentence');
            }
        }

        async function translateText(text, type) {
            try {
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=zh-CN&dt=t&q=${encodeURIComponent(text)}`;
                const res = await fetch(url);
                const data = await res.json();
                let result = "";
                if (data && data[0]) data[0].forEach(seg => { if(seg[0]) result += seg[0]; });
                if (type === 'word') document.getElementById('word-meaning').innerText = result;
                else document.getElementById('sentence-cn').innerText = result;
            } catch (e) {
                if (type === 'sentence') document.getElementById('sentence-cn').innerText = "ç¿»è¯‘å¤±è´¥";
            }
        }

        // --- 4. ç»ˆæå‘éŸ³å‡½æ•° (æ”¯æŒ Google) ---
        function speak(text) {
            // 1. åœæ­¢æ‰€æœ‰æ­£åœ¨æ’­æ”¾çš„å£°éŸ³
            if (synth.speaking) synth.cancel();
            if (googleAudio) {
                googleAudio.pause();
                googleAudio = null;
            }

            // 2. åˆ¤æ–­é€‰æ‹©çš„æ˜¯å¦æ˜¯ Google
            if (userSettings.voiceName === "Google Online") {
                try {
                    // Google TTS API (Unofficial)
                    // client=tw-ob æ˜¯å¿…é¡»è¦å¸¦çš„å‚æ•°
                    const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=en&client=tw-ob`;
                    
                    googleAudio = new Audio(url);
                    // åªæœ‰ Google æ’­æ”¾å¤±è´¥ï¼ˆæ¯”å¦‚æ²¡ç½‘ï¼‰æ—¶ï¼Œæ‰å°è¯•é™çº§åˆ°æœ¬åœ°
                    googleAudio.onerror = () => {
                        console.log("Google TTS failed, falling back to local.");
                        speakLocal(text); 
                    };
                    googleAudio.play();
                } catch (e) {
                    speakLocal(text);
                }
            } else {
                // æœ¬åœ°è¯­éŸ³
                speakLocal(text);
            }
        }

        // æœ¬åœ°è¯­éŸ³é€»è¾‘
        function speakLocal(text) {
            const u = new SpeechSynthesisUtterance(text);
            const allVoices = synth.getVoices();
            const selectedVoice = allVoices.find(v => v.name === userSettings.voiceName);
            if (selectedVoice) u.voice = selectedVoice;
            u.rate = userSettings.voiceRate || 1.0;
            synth.speak(u);
        }
    </script>
</body>
</html>